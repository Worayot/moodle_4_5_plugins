<div class="pd-16">
  <h2>Organization Report</h2>
  <div class="summary">
    <p>จำนวนผู้ใช้งานทั้งหมด: {{total_users}}</p>
    <p>สถานะการเรียนรู้ของผู้ใช้งาน: Completed: {{status.completed}}, In Progress: {{status.inprogress}}, Not Started: {{status.notstarted}}</p>
    <p>คะแนนเฉลี่ยตามแผนก/ทีม:</p>
    <ul>
      {{#departments}}
        <li>{{name}}: {{average_score}}%</li>
      {{/departments}}
      {{^departments}}
        <li>No departments data</li>
      {{/departments}}
    </ul>

    <table class="table table-striped">
      <thead>
        <tr>
          <th>ชื่อพนักงาน</th>
          <th>คอร์ส</th>
          <th>สถานะการเรียนรู้</th>
          <th>คะแนนเฉลี่ย</th>
          <th>วันเข้าครั้งล่าสุด</th>
        </tr>
      </thead>
      <tbody>
        {{#team_members}}
        <tr>
          <td>{{fullname}}</td>
          <td>
            {{#courses}}
              {{name}}<br>
            {{/courses}}
            {{^courses}}
              No data
            {{/courses}}
          </td>
          <td>
            {{#courses}}
              {{status}}<br>
            {{/courses}}
            {{^courses}}
              No data
            {{/courses}}
          </td>
          <td>
            {{#courses}}
              {{average_quiz}}%<br>
            {{/courses}}
            {{^courses}}
              No data
            {{/courses}}
          </td>
          <td>
            {{#courses}}
              {{lastaccess}}<br>
            {{/courses}}
            {{^courses}}
              No data
            {{/courses}}
          </td>
        </tr>
        {{/team_members}}
        {{^team_members}}
        <tr>
          <td colspan="5">No team members data</td>
        </tr>
        {{/team_members}}
      </tbody>
    </table>
  </div>

  <h3>Visualization</h3>
  <div class="charts-container">
    <canvas id="platformAccessChart" width="600" height="300"></canvas>
    <canvas id="departmentCompletionChart" width="600" height="300"></canvas>
    <canvas id="popularCoursesChart" width="600" height="300"></canvas>
    <canvas id="resumeCoursesChart" width="600" height="300"></canvas>
    <canvas id="courseStatusChart" width="600" height="300"></canvas>
    <canvas id="bookmarkedRarelyStartedChart" width="600" height="300"></canvas>
  </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Utility for safe arrays
  function safeData(array, defaultLabel='No data') {
    return array && array.length ? array : [defaultLabel];
  }
  function safeValues(array) {
    return array && array.length ? array : [0];
  }

  // Platform access chart
  const ctxAccess = document.getElementById('platformAccessChart').getContext('2d');
  const platformAccessChart = new Chart(ctxAccess, {
    type: 'line',
    data: {
      labels: safeData([{{#access_data}}"{{date}}",{{/access_data}}]),
      datasets: [{ label: 'Daily Access', data: safeValues([{{#access_data}}{{count}},{{/access_data}}]), borderColor: '#2a9d8f', fill: false }]
    },
    options: { scales: { y: { beginAtZero: true } } }
  });

  // Department completion pie chart
  const ctxDept = document.getElementById('departmentCompletionChart').getContext('2d');
  const departmentCompletionChart = new Chart(ctxDept, {
    type: 'pie',
    data: {
      labels: safeData([{{#departments}}"{{name}}",{{/departments}}]),
      datasets: [{
        data: safeValues([{{#departments}}{{completion_rate}},{{/departments}}]),
        backgroundColor: ['#2a9d8f', '#f4a261', '#e76f51', '#264653', '#f94144']
      }]
    }
  });

  // Popular courses
  const ctxPopular = document.getElementById('popularCoursesChart').getContext('2d');
  const popularCoursesChart = new Chart(ctxPopular, {
    type: 'bar',
    data: {
      labels: safeData([{{#popular_courses}}"{{name}}",{{/popular_courses}}]),
      datasets: [{ label: 'Bookmarks Count', data: safeValues([{{#popular_courses}}{{count}},{{/popular_courses}}]), backgroundColor: '#2a9d8f' }]
    },
    options: { scales: { y: { beginAtZero: true } } }
  });

  // Courses with most resumes
  const ctxResume = document.getElementById('resumeCoursesChart').getContext('2d');
  const resumeCoursesChart = new Chart(ctxResume, {
    type: 'bar',
    data: {
      labels: safeData([{{#resume_courses}}"{{name}}",{{/resume_courses}}]),
      datasets: [{ label: 'Resume Count', data: safeValues([{{#resume_courses}}{{count}},{{/resume_courses}}]), backgroundColor: '#f4a261' }]
    },
    options: { scales: { y: { beginAtZero: true } } }
  });

  // Course status
  const ctxCourseStatus = document.getElementById('courseStatusChart').getContext('2d');
  const courseStatusChart = new Chart(ctxCourseStatus, {
    type: 'pie',
    data: {
      labels: ['In Progress', 'Completed', 'Expired'],
      datasets: [{ data: safeValues([{{inprogress_count}}, {{completed_count}}, {{expired_count}}]), backgroundColor: ['#f4a261', '#2a9d8f', '#e76f51'] }]
    }
  });

  // Rarely started & bookmarked courses
  const ctxRareStart = document.getElementById('bookmarkedRarelyStartedChart').getContext('2d');
  const bookmarkedRarelyStartedChart = new Chart(ctxRareStart, {
    type: 'bar',
    data: {
      labels: safeData([{{#rarely_started_courses}}"{{name}}",{{/rarely_started_courses}}]),
      datasets: [{ label: 'Bookmark / Start Ratio', data: safeValues([{{#rarely_started_courses}}{{ratio}},{{/rarely_started_courses}}]), backgroundColor: '#f94144' }]
    },
    options: { scales: { y: { beginAtZero: true } } }
  });
</script>
