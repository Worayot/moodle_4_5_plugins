<div class="pd-16">
  <h2>Team Report</h2>

  <div class="analytics-section">
    <h3>Filters</h3>
    <div class="filters">
      <form method="get" action="">
        <input type="hidden" name="nav" value="reports">
        <input type="text" name="search" placeholder="Search Employee Name" value="{{search}}">
        <select name="status">
          <option value="">All Status</option>
          <option value="Completed" {{#status_completed}}selected{{/status_completed}}>Completed</option>
          <option value="In Progress" {{#status_inprogress}}selected{{/status_inprogress}}>In Progress</option>
          <option value="Expired" {{#status_expired}}selected{{/status_expired}}>Expired</option>
        </select>
        <button type="submit" class="btn btn-secondary">Filter</button>
      </form>
    </div>
  </div>

  <div class="analytics-summary">
    <div class="analytics-section">
      <h3>Team Overview</h3>
      <ul>
        <li class="analytics-list-item">
          <span class="analytics-list-label">Number of Team Members:</span>
          <span>{{team_members}}</span>
        </li>
        <li class="analytics-list-item">
          <span class="analytics-list-label">Team Average Completion Rate:</span>
          <span>{{avg_completion}}%</span>
        </li>
        <li class="analytics-list-item">
          <span class="analytics-list-label">Team Average Score:</span>
          <span>{{avg_quiz}}%</span>
        </li>
        <li class="analytics-list-item">
          <span class="analytics-list-label">Usage:</span>
          <span>{{active_users}} Active / {{inactive_users}} Inactive</span>
        </li>
      </ul>
    </div>
  </div>

  <div class="analytics-section">
    <h3>Individual Report</h3>
    <div class="table-responsive">
      <table border="1" cellpadding="4" class="table table-striped">
        <thead>
          <tr>
            <th>Name</th>
            <th>Total Courses</th>
            <th>Completed</th>
            <th>In Progress</th>
            <th>Avg Quiz</th>
            <th>Last Access</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {{#data}}
          <tr>
            <td>{{fullname}}</td>
            <td>{{courses_total}}</td>
            <td>{{courses_completed}}</td>
            <td>{{courses_inprogress}}</td>
            <td>{{average_quiz}}</td>
            <td>{{lastaccess}}</td>
            <td>{{status}}</td>
          </tr>
          {{/data}}
          {{^data}}
          <tr>
            <td colspan="7">No data available</td>
          </tr>
          {{/data}}
        </tbody>
      </table>
    </div>
  </div>

  <div class="analytics-section download-section">
    <h3>Download Report</h3>
    <a href="{{download_pdf_url}}" class="btn btn-primary">Download PDF</a>
    <a href="{{download_excel_url}}" class="btn btn-success">Download Excel</a>
  </div>

  <div class="analytics-section">
    <h3>Visualization (Graphs)</h3>
    <div class="charts-container">
      <div class="analytics-chart-box">
        <canvas id="teamCompletionChart"></canvas>
      </div>
      <div class="analytics-chart-box">
        <canvas id="teamQuizChart"></canvas>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Utility for safe chart data
    function safeChartData(data, labels, defaultLabel = 'No data available') {
        const hasData = data && data.some(val => val > 0);
        if (!hasData) {
            return { labels: [defaultLabel], data: [1] }; // Return a dummy dataset to show 'No data'
        }
        return { labels: labels, data: data };
    }

    // Team completion pie chart
    const completionChartData = [
        {{avg_completion}}, 
        {{#avg_inprogress}}{{.}}{{/avg_inprogress}}, 
        {{active_users}}
    ];
    const { labels: completionLabels, data: completionData } = safeChartData(completionChartData, ['Completed', 'In Progress', 'Active Users']);
    const ctxCompletion = document.getElementById('teamCompletionChart').getContext('2d');
    new Chart(ctxCompletion, {
      type: 'pie',
      data: {
        labels: completionLabels,
        datasets: [{
          data: completionData,
          backgroundColor: ['#2a9d8f', '#f4a261', '#e9c46a']
        }]
      },
      options: { 
        responsive: true,
        maintainAspectRatio: false
      }
    });

    // Individual quiz history line chart
    const quizLabels = [{{#data}}"{{fullname}}",{{/data}}];
    const quizData = [{{#data}}{{average_quiz}},{{/data}}];
    const { labels: quizChartLabels, data: quizChartData } = safeChartData(quizData, quizLabels, 'No quiz data');
    
    const ctxQuiz = document.getElementById('teamQuizChart').getContext('2d');
    new Chart(ctxQuiz, {
      type: 'bar',
      data: {
        labels: quizChartLabels,
        datasets: [{
          label: 'Average Quiz Score (%)',
          data: quizChartData,
          backgroundColor: '#264653'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: true, max: 100 }
        }
      }
    });
  </script>
</div>